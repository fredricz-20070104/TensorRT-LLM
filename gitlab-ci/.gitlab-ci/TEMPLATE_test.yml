#
# Template for Adding New Test Type
# 
# Instructions:
# 1. Copy this file to .gitlab-ci/<your_test_type>_test.yml
# 2. Replace <TYPE> with your test type name (e.g., multinode, perf, unit)
# 3. Replace <type> with lowercase version
# 4. Define your test-specific variables
# 5. Implement your jobs
# 6. Follow steps in README.md "Adding New Test Types" section
#

# ============================================================
# Variables Definition
# Define default values for your test type
# ============================================================
.<type>_variables: &<type>_variables
  # Example variables (customize for your test type)
  GPU: "GB200"
  CLUSTER_USERNAME: "your_username"
  TEST_TIMEOUT: "3600"
  # Add more variables specific to your test type
  # ...

# ============================================================
# Cluster Setup (if needed)
# Copy from disagg_test.yml if you need SSH/cluster access
# IMPORTANT: Use <type>-specific name to avoid conflicts!
# ============================================================
.<type>_cluster_setup: &<type>_cluster_setup
  before_script:
    # SSH setup, environment variables, etc.
    - echo "Setting up <TYPE> test environment..."
    # Copy relevant setup from disagg_test.yml if needed

# ============================================================
# Job Definitions
# All job names MUST be prefixed with <type>:
# ============================================================

<type>:init:
  stage: init
  tags:
    - selene_login  # or your runner tags
  script:
    - echo "=== Initializing <TYPE> tests ==="
    # Your initialization logic
    - echo "Creating config..."
  artifacts:
    paths:
      - config.env  # if you need to pass data between jobs
    expire_in: 1 hour
  rules:
    - if: $TEST_TYPE == "<type>"

<type>:scm:
  stage: scm
  tags:
    - selene_login
  dependencies:
    - <type>:init
  script:
    - echo "=== Cloning repositories for <TYPE> ==="
    # Your SCM logic
  artifacts:
    paths:
      - config.env
      # Add other artifacts
    expire_in: 1 hour
  rules:
    - if: $TEST_TYPE == "<type>"

<type>:test:
  stage: test
  tags:
    - selene_login
  dependencies:
    - <type>:scm
  script:
    - echo "=== Running <TYPE> tests ==="
    # Your test execution logic
  allow_failure: true  # Optional: allow test failures but continue pipeline
  artifacts:
    paths:
      - output/
      - "*.xml"
    reports:
      junit: output/**/results.xml  # Optional: JUnit reports
    expire_in: 30 days
    when: always  # Collect artifacts even on failure
  rules:
    - if: $TEST_TYPE == "<type>"

<type>:artifacts:
  stage: artifacts
  tags:
    - selene_login
  dependencies:
    - <type>:test
  when: always  # Run even if test fails
  script:
    - echo "=== Collecting <TYPE> artifacts ==="
    # Package and organize results
    - tar -czf <type>_results.tar.gz output/
  artifacts:
    name: "<type>-results-$CI_PIPELINE_ID"
    paths:
      - output/
      - "*.tar.gz"
    expire_in: 30 days
    when: always
  rules:
    - if: $TEST_TYPE == "<type>"

<type>:report:
  stage: report
  tags:
    - selene_login
  dependencies:
    - <type>:artifacts
  when: always
  script:
    - echo "=== Generating <TYPE> reports ==="
    # Generate reports, dashboards, etc.
  rules:
    - if: $TEST_TYPE == "<type>"

# ============================================================
# Additional Jobs (optional)
# Add more jobs as needed for your test type
# ============================================================

# Example: Build job (if needed)
# <type>:build:
#   stage: build
#   script:
#     - echo "Building for <TYPE> tests..."
#   rules:
#     - if: $TEST_TYPE == "<type>"

# Example: Analysis job (if needed)
# <type>:analyze:
#   stage: analyze
#   script:
#     - echo "Analyzing <TYPE> results..."
#   rules:
#     - if: $TEST_TYPE == "<type>"

# ============================================================
# Notes:
# - All job names must be unique across all test types
# - Use <type>: prefix to avoid conflicts
# - Add rules: - if: $TEST_TYPE == "<type>" to ALL jobs
# - Use artifacts to pass data between jobs
# - Set appropriate expire_in for artifacts
# - Use when: always for cleanup/reporting jobs
# ============================================================

