#
# GitLab CI/CD Pipeline for TensorRT-LLM Disaggregated Performance Testing
# Approach 1: Split Job Names + needs Chain
# 
# Each GPU (GB200/GB300/GB200_LYRIS) forms an independent execution chain:
#   init → scm → sync → build → setup → test → artifacts → analyze → report
#
# GB200, GB300, and GB200_LYRIS pipelines run completely independently in parallel.
# Each GPU can proceed to test/analyze while others are still in sync stage.
#

# ============================================================
# Common Variables
# ============================================================

.disagg_variables: &disagg_variables
  CLUSTER_USERNAME: "fredricz"
  DOCKER_IMAGE: ""
  WHEEL_URL: ""
  INSTALL_MODE: "wheel"
  TEST_MODEL: "kimi-k2 and 1k1k"
  LLM_VERSION: "1.2.0rc5"
  TRT_LLM_BRANCH: "main"
  TRT_LLM_REPO: "fredricz-20070104/TensorRT-LLM"
  TIMEOUT: "3600"
  TEST_TIME: "4:00:00"
  WRITE_PERF_DB: "true"
  UPDATE_WAIVE: "false"
  CREATE_BUG: "false"
  FORK_GITHUB: "true"
  DISAGG_MULTI_NODE_TEST_LIST: "testlist/wideep.txt"
  FAILED_RERUN: "0"
  TENSORRT_VERSION: "10.8.0.32"
  CUDA_VERSION: "12.8"
  REPORT_DIR: "output"
  RUN_GB200: "false"
  RUN_GB300: "false"
  RUN_GB200LYRIS: "false"

# ============================================================
# Common Script Templates (to reduce duplication)
# ============================================================

.disagg_validate_common_script: &disagg_validate_common_script
  - bash scripts/disagg/1_validate.sh "${GPU}"

.disagg_init_common_script: &disagg_init_common_script
  - bash scripts/disagg/2_init.sh "${GPU}"

.disagg_scm_common_script: &disagg_scm_common_script
  - bash scripts/disagg/3_scm.sh "${GPU}"

.disagg_sync_common_script: &disagg_sync_common_script
  - bash scripts/disagg/4_sync.sh "${GPU}"

.disagg_build_common_script: &disagg_build_common_script
  - bash scripts/disagg/5_build.sh "${GPU}"

.disagg_setup_common_script: &disagg_setup_common_script
  - bash scripts/disagg/6_setup.sh "${GPU}"

.disagg_test_common_script: &disagg_test_common_script
  - bash scripts/disagg/7_test.sh "${GPU}"

.disagg_artifacts_common_script: &disagg_artifacts_common_script
  - bash scripts/disagg/8_artifacts.sh "${GPU}"

.disagg_report_common_script: &disagg_report_common_script
  - bash scripts/disagg/10_report.sh "${GPU}"

.disagg_analyze_common_script: &disagg_analyze_common_script
  - bash scripts/disagg/9_analyze.sh "${GPU}"

# ============================================================
# GB200 Base Configuration Template
# ============================================================

.disagg_gb200_base: &disagg_gb200_base
  variables:
    <<: *disagg_variables
    GPU: "GB200"
    RUNNER_TAG: "selene_login"
  tags:
    - selene_login
  before_script:
    - export GPU="GB200"
    - export RUNNER_TAG="selene_login"
    - export WORKDIR="$(basename "$CI_PROJECT_DIR")-pipeline-${CI_PIPELINE_ID}-${GPU}"
    - export CONFIG_KEY="GB200"
    - export CLUSTER_ACCOUNT="coreai_comparch_trtllm"
    - export CLUSTER_PARTITION="batch"
    - export CLUSTER_STORAGE="/lustre/fs1/portfolios/coreai/projects/coreai_comparch_trtllm/common"
    - export CLUSTER_LLM_DATA="/lustre/fs1/portfolios/coreai/projects/coreai_comparch_trtllm/common"
    - export CCACHE_DIR="/lustre/fs1/portfolios/coreai/projects/coreai_comparch_trtllm/common/ccache_${GITLAB_USER_LOGIN}"
    - export HOST="oci-hsg-cs-001-login-01"
    - export EXTRA_SRUN_PARAMS="--gres=gpu:4"
    - export CLUSTER_WORKDIR="${CLUSTER_STORAGE}/trtllm_ci/perf/${HOST}/${WORKDIR}"
    - export MPI_TYPE="pmix"
    - export BASE_SRUN="srun --mpi=${MPI_TYPE} -t ${TEST_TIME} -A ${CLUSTER_ACCOUNT} -N1 -p ${CLUSTER_PARTITION} -J ${CLUSTER_ACCOUNT}-trt:test ${EXTRA_SRUN_PARAMS}"
    - export CLUSTER_USERNAME="${CLUSTER_USERNAME}"
    # SSH setup for GB200 (remote execution)
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts
  rules:
    - if: '$TEST_TYPE == "disagg" && $RUN_GB200 == "true"'
    - if: '$TEST_TYPE == "disagg" && $RUN_GB200 != "true" && $RUN_GB300 != "true" && $RUN_GB200LYRIS != "true"'

# ============================================================
# GB300 Base Configuration Template
# ============================================================

.disagg_gb300_base: &disagg_gb300_base
  variables:
    <<: *disagg_variables
    GPU: "GB300"
    RUNNER_TAG: "lyris"
  tags:
    - lyris
  before_script:
    - export GPU="GB300"
    - export RUNNER_TAG="lyris"
    - export WORKDIR="$(basename "$CI_PROJECT_DIR")-pipeline-${CI_PIPELINE_ID}-${GPU}"
    - export CONFIG_KEY="GB300"
    - export CLUSTER_ACCOUNT="coreai_comparch_trtllm"
    - export CLUSTER_PARTITION="gb300"
    - export CLUSTER_STORAGE="/lustre/fsw/coreai_comparch_trtllm/common"
    - export CLUSTER_LLM_DATA="/lustre/fsw/coreai_comparch_trtllm/common"
    - export CCACHE_DIR="/lustre/fsw/coreai_comparch_trtllm/common/ccache_${GITLAB_USER_LOGIN}"
    - export HOST="login-lyris02"
    - export EXTRA_SRUN_PARAMS=""
    - export CLUSTER_WORKDIR="${CLUSTER_STORAGE}/trtllm_ci/perf/${HOST}/${WORKDIR}"
    - export MPI_TYPE="pmix"
    - export BASE_SRUN="srun --mpi=${MPI_TYPE} -t ${TEST_TIME} -A ${CLUSTER_ACCOUNT} -N1 -p ${CLUSTER_PARTITION} -J ${CLUSTER_ACCOUNT}-trt:test ${EXTRA_SRUN_PARAMS}"
    - export CLUSTER_USERNAME="${CLUSTER_USERNAME}"
    - echo "✓ GB300 runner is on the cluster, using local execution"
  rules:
    - if: '$TEST_TYPE == "disagg" && $RUN_GB300 == "true"'
    - if: '$TEST_TYPE == "disagg" && $RUN_GB200 != "true" && $RUN_GB300 != "true" && $RUN_GB200LYRIS != "true"'

# ============================================================
# GB200_LYRIS Base Configuration Template
# ============================================================

.disagg_gb200lyris_base: &disagg_gb200lyris_base
  variables:
    <<: *disagg_variables
    GPU: "GB200_LYRIS"
    RUNNER_TAG: "lyris"
  tags:
    - lyris
  before_script:
    - export GPU="GB200_LYRIS"
    - export RUNNER_TAG="lyris"
    - export WORKDIR="$(basename "$CI_PROJECT_DIR")-pipeline-${CI_PIPELINE_ID}-${GPU}"
    - export CONFIG_KEY="GB200_LYRIS"
    - export CLUSTER_ACCOUNT="coreai_comparch_trtllm"
    - export CLUSTER_PARTITION="gb200"
    - export CLUSTER_STORAGE="/lustre/fsw/coreai_comparch_trtllm/common"
    - export CLUSTER_LLM_DATA="/lustre/fsw/coreai_comparch_trtllm/common"
    - export CCACHE_DIR="/lustre/fsw/coreai_comparch_trtllm/common/ccache_${GITLAB_USER_LOGIN}"
    - export HOST="login-lyris02"
    - export EXTRA_SRUN_PARAMS=""
    - export CLUSTER_WORKDIR="${CLUSTER_STORAGE}/trtllm_ci/perf/${HOST}/${WORKDIR}"
    - export MPI_TYPE="pmix"
    - export BASE_SRUN="srun --mpi=${MPI_TYPE} -t ${TEST_TIME} -A ${CLUSTER_ACCOUNT} -N1 -p ${CLUSTER_PARTITION} -J ${CLUSTER_ACCOUNT}-trt:test ${EXTRA_SRUN_PARAMS}"
    - export CLUSTER_USERNAME="${CLUSTER_USERNAME}"
    - echo "✓ GB200_LYRIS runner is on the cluster, using local execution"
  rules:
    - if: '$TEST_TYPE == "disagg" && $RUN_GB200LYRIS == "true"'
    - if: '$TEST_TYPE == "disagg" && $RUN_GB200 != "true" && $RUN_GB300 != "true" && $RUN_GB200LYRIS != "true"'

# ============================================================
# Stage: .pre - Validation
# ============================================================

disagg:validate:gb200:
  stage: .pre
  <<: *disagg_gb200_base
  script: *disagg_validate_common_script

disagg:validate:gb300:
  stage: .pre
  <<: *disagg_gb300_base
  script: *disagg_validate_common_script

disagg:validate:gb200lyris:
  stage: .pre
  <<: *disagg_gb200lyris_base
  script: *disagg_validate_common_script

# ============================================================
# Stage: init - Initialize Configuration
# ============================================================

disagg:init:gb200:
  stage: init
  <<: *disagg_gb200_base
  script: *disagg_init_common_script
  artifacts:
    paths:
      - config_GB200.env
      - docker_image_GB200.txt
      - download_url_GB200.txt

disagg:init:gb300:
  stage: init
  <<: *disagg_gb300_base
  script: *disagg_init_common_script
  artifacts:
    paths:
      - config_GB300.env
      - docker_image_GB300.txt
      - download_url_GB300.txt

disagg:init:gb200lyris:
  stage: init
  <<: *disagg_gb200lyris_base
  script: *disagg_init_common_script
  artifacts:
    paths:
      - config_GB200_LYRIS.env
      - docker_image_GB200_LYRIS.txt
      - download_url_GB200_LYRIS.txt

# ============================================================
# Stage: scm - Clone Repositories
# ============================================================

disagg:scm:gb200:
  stage: scm
  <<: *disagg_gb200_base
  needs:
    - job: disagg:init:gb200
      artifacts: true
  script: *disagg_scm_common_script
  artifacts:
    paths:
      - config_GB200.env
      - forest_GB200/

disagg:scm:gb300:
  stage: scm
  <<: *disagg_gb300_base
  needs:
    - job: disagg:init:gb300
      artifacts: true
  script: *disagg_scm_common_script
  artifacts:
    paths:
      - config_GB300.env
      - forest_GB300/

disagg:scm:gb200lyris:
  stage: scm
  <<: *disagg_gb200lyris_base
  needs:
    - job: disagg:init:gb200lyris
      artifacts: true
  script: *disagg_scm_common_script
  artifacts:
    paths:
      - config_GB200_LYRIS.env
      - forest_GB200_LYRIS/

# ============================================================
# Stage: sync - Sync Data to Cluster
# ============================================================

disagg:sync:gb200:
  stage: sync
  <<: *disagg_gb200_base
  needs:
    - job: disagg:scm:gb200
      artifacts: true
  script: *disagg_sync_common_script
  artifacts:
    paths:
      - config_final_GB200.env  # Final version with all variables

disagg:sync:gb300:
  stage: sync
  <<: *disagg_gb300_base
  needs:
    - job: disagg:scm:gb300
      artifacts: true
  script: *disagg_sync_common_script
  artifacts:
    paths:
      - config_final_GB300.env  # Final version with all variables

disagg:sync:gb200lyris:
  stage: sync
  <<: *disagg_gb200lyris_base
  needs:
    - job: disagg:scm:gb200lyris
      artifacts: true
  script: *disagg_sync_common_script
  artifacts:
    paths:
      - config_final_GB200_LYRIS.env  # Final version with all variables

# ============================================================
# Stage: build - Build Wheel
# ============================================================

disagg:build:gb200:
  stage: build
  <<: *disagg_gb200_base
  needs:
    - job: disagg:sync:gb200
      artifacts: true
  script: *disagg_build_common_script
  artifacts:
    paths:
      - config_final_GB200.env

disagg:build:gb300:
  stage: build
  <<: *disagg_gb300_base
  needs:
    - job: disagg:sync:gb300
      artifacts: true
  script: *disagg_build_common_script
  artifacts:
    paths:
      - config_final_GB300.env

disagg:build:gb200lyris:
  stage: build
  <<: *disagg_gb200lyris_base
  needs:
    - job: disagg:sync:gb200lyris
      artifacts: true
  script: *disagg_build_common_script
  artifacts:
    paths:
      - config_final_GB200_LYRIS.env

# ============================================================
# Stage: setup - Setup Environment
# ============================================================

disagg:setup:gb200:
  stage: setup
  <<: *disagg_gb200_base
  needs:
    - job: disagg:build:gb200
      artifacts: true
  script: *disagg_setup_common_script
  artifacts:
    paths:
      - config_final_GB200.env

disagg:setup:gb300:
  stage: setup
  <<: *disagg_gb300_base
  needs:
    - job: disagg:build:gb300
      artifacts: true
  script: *disagg_setup_common_script
  artifacts:
    paths:
      - config_final_GB300.env

disagg:setup:gb200lyris:
  stage: setup
  <<: *disagg_gb200lyris_base
  needs:
    - job: disagg:build:gb200lyris
      artifacts: true
  script: *disagg_setup_common_script
  artifacts:
    paths:
      - config_final_GB200_LYRIS.env

# ============================================================
# Stage: test - Run Disaggregated Tests
# ============================================================

disagg:test:gb200:
  stage: test
  <<: *disagg_gb200_base
  needs:
    - job: disagg:setup:gb200
      artifacts: true
  script: *disagg_test_common_script
  artifacts:
    paths:
      - config_final_GB200.env
    when: always
  when: always

disagg:test:gb300:
  stage: test
  <<: *disagg_gb300_base
  needs:
    - job: disagg:setup:gb300
      artifacts: true
  script: *disagg_test_common_script
  artifacts:
    paths:
      - config_final_GB300.env
    when: always
  when: always

disagg:test:gb200lyris:
  stage: test
  <<: *disagg_gb200lyris_base
  needs:
    - job: disagg:setup:gb200lyris
      artifacts: true
  script: *disagg_test_common_script
  artifacts:
    paths:
      - config_final_GB200_LYRIS.env
    when: always
  when: always

# ============================================================
# Stage: artifacts - Collect Artifacts
# ============================================================

disagg:artifacts:gb200:
  stage: artifacts
  <<: *disagg_gb200_base
  needs:
    - job: disagg:test:gb200
      artifacts: true
  when: always
  script: *disagg_artifacts_common_script
  artifacts:
    name: "disagg-test-results-GB200-$CI_PIPELINE_ID"
    paths:
      - config_final_GB200.env
      - output/
      - "*_GB200.tar.gz"
    reports:
      junit: output/tmp*/results.xml
    expire_in: 30 days
    when: always

disagg:artifacts:gb300:
  stage: artifacts
  <<: *disagg_gb300_base
  needs:
    - job: disagg:test:gb300
      artifacts: true
  when: always
  script: *disagg_artifacts_common_script
  artifacts:
    name: "disagg-test-results-GB300-$CI_PIPELINE_ID"
    paths:
      - config_final_GB300.env
      - output/
      - "*_GB300.tar.gz"
    reports:
      junit: output/tmp*/results.xml
    expire_in: 30 days
    when: always

disagg:artifacts:gb200lyris:
  stage: artifacts
  <<: *disagg_gb200lyris_base
  needs:
    - job: disagg:test:gb200lyris
      artifacts: true
  when: always
  script: *disagg_artifacts_common_script
  artifacts:
    name: "disagg-test-results-GB200_LYRIS-$CI_PIPELINE_ID"
    paths:
      - config_final_GB200_LYRIS.env
      - output/
      - "*_GB200_LYRIS.tar.gz"
    reports:
      junit: output/tmp*/results.xml
    expire_in: 30 days
    when: always

# ============================================================
# Stage: analyze - Analyze Results
# ============================================================

disagg:analyze:gb200:
  stage: analyze
  <<: *disagg_gb200_base
  needs:
    - job: disagg:scm:gb200
      artifacts: true  # Get forest_GB200/
    - job: disagg:artifacts:gb200
      artifacts: true  # Get config_final_GB200.env + output/
  when: always
  script: *disagg_analyze_common_script

disagg:analyze:gb300:
  stage: analyze
  <<: *disagg_gb300_base
  needs:
    - job: disagg:scm:gb300
      artifacts: true  # Get forest_GB300/
    - job: disagg:artifacts:gb300
      artifacts: true  # Get config_final_GB300.env + output/
  when: always
  script: *disagg_analyze_common_script

disagg:analyze:gb200lyris:
  stage: analyze
  <<: *disagg_gb200lyris_base
  needs:
    - job: disagg:scm:gb200lyris
      artifacts: true  # Get forest_GB200_LYRIS/
    - job: disagg:artifacts:gb200lyris
      artifacts: true  # Get config_final_GB200_LYRIS.env + output/
  when: always
  script: *disagg_analyze_common_script

# ============================================================
# Stage: report - Generate Reports
# ============================================================

disagg:report:gb200:
  stage: report
  <<: *disagg_gb200_base
  needs:
    - job: disagg:artifacts:gb200
      artifacts: true
  when: always
  script: *disagg_report_common_script

disagg:report:gb300:
  stage: report
  <<: *disagg_gb300_base
  needs:
    - job: disagg:artifacts:gb300
      artifacts: true
  when: always
  script: *disagg_report_common_script

disagg:report:gb200lyris:
  stage: report
  <<: *disagg_gb200lyris_base
  needs:
    - job: disagg:artifacts:gb200lyris
      artifacts: true
  when: always
  script: *disagg_report_common_script

